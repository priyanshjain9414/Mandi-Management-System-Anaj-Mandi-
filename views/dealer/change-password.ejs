<% layout("/layouts/boilerplate") %>

<style>
  body {
    font-family: "Poppins", sans-serif;
    background: linear-gradient(135deg, #d8f3dc, #f1faee);
  }

  .verify-card {
    background: #fff;
    border-radius: 18px;
    padding: 35px;
    box-shadow: 0 14px 40px rgba(0, 0, 0, 0.12);
  }

  .form-control {
    padding: 12px;
  }

  .form-control:focus {
    box-shadow: none;
    border-color: #52b788;
  }

  .verify-title {
    font-weight: 600;
    color: #1b4332;
  }
</style>

<div class="row mt-5">
  <div class="col-12 mx-auto" style="max-width: 450px">
    <div class="verify-card">
      <h4 class="text-center mb-4 verify-title">
        <i class="fa-solid fa-lock me-2"></i>
        Change Mandi Password
      </h4>

      <!-- ================= SEND OTP ================= -->
      <form method="POST" action="/dealer/change-password/send-otp">
        <!-- EMAIL -->
        <div class="mb-3">
          <label class="form-label">Email</label>

          <% if (isLoggedInUser) { %>
          <input
            type="email"
            class="form-control"
            value="<%= dealer.email %>"
            readonly
          />
          <% } else { %>
          <input
            type="email"
            name="email"
            class="form-control"
            placeholder="Enter your registered email"
            required
          />
          <% } %>
        </div>

        <!-- EMAIL APP PASSWORD -->
        <div class="mb-3">
          <% if (isLoggedInUser) { %>

          <button
            type="button"
            class="btn btn-outline-success w-100"
            id="togglePasswordBtn"
          >
            <i class="fa-solid fa-key me-1"></i> Change Email App Password
          </button>

          <div class="mt-2 d-none" id="passwordWrapper">
            <input
              type="password"
              name="emailAppPassword"
              class="form-control"
              placeholder="Enter new App Password"
            />
          </div>

          <% } else { %>

          <label class="form-label">Email App Password</label>
          <input
            type="password"
            name="emailAppPassword"
            class="form-control"
            placeholder="Enter your email app password"
            required
          />

          <% } %>
        </div>

        <button class="btn btn-success w-100 mb-3">
          <i class="fa-solid fa-paper-plane me-1"></i>
          Send OTP to Email
        </button>
      </form>

      <hr />

      <!-- ========= VERIFY OTP + NEW PASSWORD ========== -->
      <form method="POST" action="/dealer/change-password/verify-otp">
        <div class="mb-3">
          <label class="form-label">Enter OTP</label>
          <input
            type="text"
            name="otp"
            class="form-control"
            placeholder="6-digit OTP"
            required
          />
        </div>

        <div class="mb-3">
          <label class="form-label">New Password</label>
          <input
            type="password"
            name="newPassword"
            class="form-control"
            placeholder="Enter new password"
            required
          />
        </div>

        <button class="btn btn-warning w-100">
          <i class="fa-solid fa-key me-1"></i>
          Change Password
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  const toggleBtn = document.getElementById("togglePasswordBtn");
  const passwordWrapper = document.getElementById("passwordWrapper");

  if (toggleBtn) {
    toggleBtn.addEventListener("click", () => {
      passwordWrapper.classList.toggle("d-none");

      toggleBtn.innerHTML = passwordWrapper.classList.contains("d-none")
        ? '<i class="fa-solid fa-key me-1"></i> Change Email App Password'
        : '<i class="fa-solid fa-xmark me-1"></i> Cancel Password Change';
    });
  }
</script>
