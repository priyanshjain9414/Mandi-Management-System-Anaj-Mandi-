<% layout("/layouts/boilerplate") %>

<div class="container mt-4">
  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold text-success">
      <i class="fa-solid fa-hand-holding-dollar text-success me-2"></i>
      Loan Details
      <span class="badge bg-success ms-2"><%= loan.loanId %></span>
    </h3>

    <div class="d-flex gap-2">
      <% if (loan.paidAmount === 0 && loan.interestAmount === 0) { %>
      <form action="/loan/<%= loan.loanId %>?_method=DELETE" method="POST">
        <button
          class="btn btn-danger"
          onclick="return confirm('Delete unpaid loan?')"
        >
          <i class="fa-solid fa-trash me-1"></i>
          Delete Loan
        </button>
      </form>
      <% } %>

      <a
        href="/receipt/loan/<%= loan.loanId %>"
        target="_blank"
        class="btn btn-outline-secondary"
      >
        <i class="fa-solid fa-print me-1"></i> Print Receipt
      </a>

      <a href="javascript:history.back()" class="btn btn-outline-secondary">
        <i class="fa-solid fa-arrow-left me-1"></i> Back
      </a>
    </div>
  </div>

  <!-- ================= LOAN BASIC INFO ================= -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0">Loan Information</h5>
    </div>

    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <strong>Farmer Name</strong>
          <p class="mb-0"><%= loan.personName %></p>
        </div>

        <div class="col-md-6">
          <strong>Farmer ID</strong>
          <p class="mb-0"><%= loan.farmerBusinessId %></p>
        </div>

        <div class="col-md-6">
          <strong>Loan ID</strong>
          <p class="mb-0"><%= loan.loanId %></p>
        </div>

        <div class="col-md-6">
          <strong>Date Given</strong>
          <p class="mb-0"><%= loan.createdAt.toDateString() %></p>
        </div>

        <div class="col-md-6">
          <strong>Loan Amount</strong>
          <p class="fw-bold mb-0">₹ <%= loan.loanAmount %></p>
        </div>

        <div class="col-md-6">
          <strong>Interest (%)</strong>
          <p class="mb-0"><%= loan.interest %> %</p>
        </div>

        <div class="col-md-6">
          <strong>Remark</strong>
          <p class="mb-0"><%= loan.remark %></p>
        </div>
        <div class="col-md-6">
          <strong>Status</strong>
          <span
            class="badge <%= loan.status === 'FINISHED' ? 'bg-success' : 'bg-warning' %>"
          >
            <%= loan.status %>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= LOAN SUMMARY ================= -->
  <div class="row row-cols-1 row-cols-md-5 g-3 text-center mb-4">
    <div class="col">
      <div class="card border-success shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted">Loan</h6>
          <h4 class="fw-bold text-success">₹ <%= loan.loanAmount %></h4>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card border-warning shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted">Interest</h6>
          <h4 class="fw-bold text-warning">₹ <%= loan.interestAmount %></h4>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card border-dark shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted">Total</h6>
          <h4 class="fw-bold">₹ <%= loan.loanAmount+loan.interestAmount %></h4>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card border-primary shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted">Paid</h6>
          <h4 class="fw-bold text-primary">₹ <%= loan.paidAmount %></h4>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card border-danger shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted">Pending</h6>
          <h4 class="fw-bold text-danger">
            ₹ <%= loan.pendingAmount ?? loan.loanAmount%>
          </h4>
        </div>
      </div>
    </div>
  </div>

  <hr />
  <!-- ================= PAYMENT HISTORY ================= -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white">
      <h5 class="mb-0">Payment History</h5>
    </div>

    <div class="card-body">
      <% if (payments.length > 0) { %>
      <div class="row">
        <% payments.forEach(p => { const tx = p.payments.find( x =>
        x.loanId.toString() === loan._id.toString() ); if (!tx) return; %>

        <div class="col-md-6 mb-3">
          <div class="card shadow-sm border-primary h-100">
            <div class="card-body">
              <h6 class="fw-bold mb-2">
                <%= p.createdAt ? new Date(p.createdAt).toDateString() : "—" %>
              </h6>

              <% if (p.isReversal) { %>
              <strong>Mode:</strong>
              <span class="badge bg-danger mb-1">REVERSAL</span>
              <p class="mb-1">
                <strong>Reverses PaymentId: </strong><%= p.reversedPaymentId%>
              </p>
              <% } else { %>
              <strong>Mode:</strong>
              <span class="badge bg-info text-dark mb-1"><%= p.mode %></span>
              <p class="mb-1">
                <strong>Payment Id: </strong><%= p.paymentId %>
              </p>
              <% } %>

              <hr />

              <p class="mb-1">
                <strong>Principal Pending (Before):</strong>
                ₹ <%=p.isReversal ?
                tx.totalPayableBefore-Math.abs(tx.paidAmount) :
                tx.principalPendingBefore%>
              </p>

              <p class="mb-1">
                <strong>Interest Period:</strong>
                <%= tx.periodIndays %> days
              </p>

              <p class="mb-1">
                <strong>Interest Amount:</strong>
                ₹ <%= tx.interestAmount %>
              </p>

              <p class="mb-2 fw-bold">
                <strong>Total Payable (Before):</strong>
                ₹ <%=p.isReversal ?
                tx.principalPendingBefore-Math.abs(tx.paidAmount) :
                tx.totalPayableBefore %>
              </p>

              <hr />

              <% if (p.isReversal) { %>
              <p class="fw-bold text-danger mb-1 mt-1">
                Reversed Amount: ₹ <%= Math.abs(tx.paidAmount) %>
              </p>
              <% } else { %>
              <p class="fw-bold text-success mb-1 mt-1">
                Paid Amount: ₹ <%= tx.paidAmount %>
              </p>
              <% } %>

              <p class="mb-0 text-danger fw-bold">
                Remaining Amount: ₹ <%= tx.pendingAmountAfter %>
              </p>

              <span
                class="badge <%= p.isReversal ? 'bg-danger' : tx.loanStatusAfter === 'FINISHED' ? 'bg-success' : 'bg-warning' %>"
              >
                <%= p.isReversal ? 'REVERSED' : tx.loanStatusAfter %>
              </span>
            </div>
          </div>
        </div>

        <% }) %>
      </div>
      <% } else { %>
      <div class="alert alert-success text-center shadow-sm mb-0">
        <strong> No Transaction On This Loan Yet</strong>
      </div>
      <% } %>
    </div>
  </div>
  <hr />
  <!-- ================= CALCULATE BUTTON ================= -->
  <% if (loan.status !== "FINISHED") { %>
  <div class="card shadow-sm mt-4">
    <div class="card-body text-center">
      <button class="btn btn-outline-success" onclick="toggleCalc()">
        Calculate Till Today
      </button>

      <div id="calcBox" class="d-none mt-3 border rounded p-3 bg-light">
        <% const fromDate = loan.updatedAt || loan.createdAt; const days =
        Math.ceil( (Date.now() - new Date(fromDate)) / (1000 * 60 * 60 * 24) );
        const base = loan.pendingAmount || loan.loanAmount; const interestAmount
        = (base * loan.interest * days) / 36500; const total = Math.round(base +
        interestAmount); %>

        <p><strong>Principal Pending:</strong> ₹ <%= base %></p>
        <p><strong>Days:</strong> <%= days %></p>
        <p><strong>Interest %:</strong> <%= loan.interest %></p>
        <p>
          <strong>Interest Amount:</strong> ₹ <%= Math.round(interestAmount) %>
        </p>
        <p class="fw-bold">Total Payable Today: ₹ <%= total %></p>
      </div>
    </div>
  </div>
  <% } %>

  <script>
    function toggleCalc() {
      document.getElementById("calcBox").classList.toggle("d-none");
    }
  </script>
</div>
